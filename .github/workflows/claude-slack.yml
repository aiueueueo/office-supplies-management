name: Claude PR Review with Slack

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  pr-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}                     # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãªã„å ´åˆã®è¨­å®š
          # create_branch: false        
          # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼ˆ.mcp.jsonã®è¨­å®šã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼‰
          mcp_config: |
            {
              "mcpServers": {
                "slack": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "SLACK_BOT_TOKEN",
                    "-e",
                    "SLACK_TEAM_ID",
                    "-e",
                    "SLACK_CHANNEL_IDS",
                    "mcp/slack"
                  ],
                  "env": {
                    "SLACK_BOT_TOKEN": "${{ secrets.SLACK_BOT_TOKEN }}",
                    "SLACK_TEAM_ID": "${{ secrets.SLACK_TEAM_ID }}",
                    "SLACK_CHANNEL_IDS": "${{ secrets.SLACK_CHANNEL_ID }}"
                  }
                }
              }
            }
          
          # Slackãƒ„ãƒ¼ãƒ«ã‚’è¨±å¯
          allowed_tools: |
            Read
            Grep
            mcp__slack__slack_list_channels
            mcp__slack__slack_post_message
            mcp__slack__slack_get_channel_history
            mcp__slack__slack_get_users
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œã¨Slacké€šçŸ¥
          direct_prompt: |
            PR #${{ github.event.pull_request.number }} ã‚’æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€
            çµæœã‚’ä»¥ä¸‹ã®å½¢å¼ã§Slackã«é€ä¿¡ã—ã¦ãã ã•ã„ï¼š
            
            ğŸ” PR: ${{ github.event.pull_request.title }}
            ğŸ‘¤ ä½œæˆè€…: ${{ github.event.pull_request.user.login }}
            
            ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ:
            [ã“ã“ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹]
            
            ğŸ”— ${{ github.event.pull_request.html_url }}